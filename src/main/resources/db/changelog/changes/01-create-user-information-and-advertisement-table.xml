<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="01-01-base-schema-refactored-v2" author="ostap" runAlways="false" runOnChange="false">

    <createTable tableName="user_information">
      <column name="id" type="BIGSERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/> </column>
      <column name="password_hash" type="VARCHAR(255)"/>
      <column name="role" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>
      <column name="locale" type="VARCHAR(10)">
        <constraints nullable="true"/> </column>
    </createTable>

    <sql>
      ALTER TABLE user_information
      ADD CONSTRAINT chk_user_role
      CHECK (role IN ('ADMIN', 'USER', 'MODERATOR'));
    </sql>

    <createTable tableName="advertisement">
      <column name="id" type="BIGSERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="title" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="TEXT"/>
      <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP WITH TIME ZONE"/>

      <column name="created_by_user_id" type="BIGINT">
        <constraints nullable="false"/> </column>
      <column name="last_modified_by_user_id" type="BIGINT"/>

    </createTable>

    <addForeignKeyConstraint baseTableName="advertisement"
      baseColumnNames="created_by_user_id"
      constraintName="fk_advertisement_created_by"
      referencedTableName="user_information"
      referencedColumnNames="id"
      onDelete="RESTRICT"/> <addForeignKeyConstraint baseTableName="advertisement"
    baseColumnNames="last_modified_by_user_id"
    constraintName="fk_advertisement_modified_by"
    referencedTableName="user_information"
    referencedColumnNames="id"
    onDelete="SET NULL"/> <createIndex indexName="idx_advertisement_title" tableName="advertisement">
    <column name="title"/>
  </createIndex>
    <createIndex indexName="idx_advertisement_created_at" tableName="advertisement">
      <column name="created_at"/>
    </createIndex>
    <createIndex indexName="idx_advertisement_created_by" tableName="advertisement">
      <column name="created_by_user_id"/>
    </createIndex>

  </changeSet>
  <changeSet id="01-02-test-data" author="ostap">
    <sqlFile path="test-data.sql" relativeToChangelogFile="true"/>
  </changeSet>


</databaseChangeLog>
